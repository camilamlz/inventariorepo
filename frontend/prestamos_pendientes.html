<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prestamos Pendientes</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container">
        <h2 class="mt-4 mb-3">Préstamos Pendientes</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>ID Préstamo</th>
                    <th>Empleado/Docente</th>
                    <th>Equipo</th>
                    <th>Fecha de Solicitud</th>
                    <th>Fecha de Entrega</th>
                    <th>Fecha de Retiro</th>
                    <th>Dirección de Entrega</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="prestamosPendientesBody"></tbody>
        </table>
    </div>

    <script>
        // Realizar una petición para obtener los préstamos pendientes
        fetch('/prestamos_pendientes')
            .then(response => response.json())
            .then(prestamos => {
                // Una vez recibida la respuesta, mostrar los préstamos pendientes en la tabla
                const prestamosPendientesBody = document.getElementById('prestamosPendientesBody');
                console.log('Datos:', prestamos);
                prestamos.forEach(prestamo => {
                    // Crear una nueva fila para cada préstamo
                    const row = document.createElement('tr');

                    // Agregar las celdas con los datos del préstamo
                    row.innerHTML = `
                        <td>${prestamo.id_préstamo}</td>
                        <td>${prestamo.nombre_empleado_docente}</td>
                        <td>${prestamo.nombre_equipo}</td>
                        <td>${prestamo.fecha_solicitud}</td>
                        <td><input type="date" id="fechaEntrega_${prestamo.id_préstamo}" name="fechaEntrega" required></td>
                        <td>${prestamo.fecha_retiro}</td>
                        <td>${prestamo.dirección_entrega}</td>
                        <td>${prestamo.estado}</td>
                        <td>
                            <button class="btn btn-success" onclick="aprobarPrestamo(${prestamo.id_préstamo})">Aprobar</button>
                            <button class="btn btn-danger" onclick="rechazarPrestamo(${prestamo.id_préstamo})">Rechazar</button>
                        </td>
                    `;
                    
                    // Agregar la fila a la tabla
                    prestamosPendientesBody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error al obtener préstamos pendientes:', error);
                alert('Ocurrió un error al obtener los préstamos pendientes');
            });

        // Función para aprobar un préstamo
        function aprobarPrestamo(idPrestamo) {
            const fechaEntrega = document.getElementById(`fechaEntrega_${idPrestamo}`).value;
            // Realizar una petición para aprobar el préstamo con el ID correspondiente
            const userId = sessionStorage.getItem('userId');
           
            fetch('/prestamo_aprobar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    id_empleado_docente: userId, // Cambiar por el valor adecuado
                    estado: 'aprobado', 
                    fecha_entrega: fechaEntrega, 
                    id_prestamo: idPrestamo 
                })
                
            })
            .then(response => response.json())
            .then(data => {
                console.log('resp:', data);
                alert(data.message);
                 // Mostrar mensaje de éxito o error
                // Actualizar la lista de préstamos pendientes después de aprobar o rechazar
                location.reload();
            })
            .catch(error => {
                console.error('Error al aprobar el préstamo:', error);
                alert('Ocurrió un error al aprobar el préstamo');
            });
        }

        // Función para rechazar un préstamo
        function rechazarPrestamo(idPrestamo) {
            const fechaEntrega = document.getElementById(`fechaEntrega_${idPrestamo}`).value;
          
          const fechaActual = obtenerFechaActual();
            const userId = sessionStorage.getItem('userId');
            // Realizar una petición para aprobar el préstamo con el ID correspondiente

            fetch('/prestamo_rechazar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    id_empleado_docente: userId, // Cambiar por el valor adecuado
                    estado: 'rechazado', 
                    fecha_entrega: fechaActual, 
                    id_prestamo: idPrestamo 
                })
                
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message); // Mostrar mensaje de éxito o error
                // Actualizar la lista de préstamos pendientes después de aprobar o rechazar
                location.reload();
            })
            .catch(error => {
                console.error('Error al rechazar el préstamo:', error);
                alert('Ocurrió un error al rechazar el préstamo');
            });
        }


        document.addEventListener('DOMContentLoaded', function() {
            // Recuperar el ID de usuario almacenado en sessionStorage
            const userType = sessionStorage.getItem('userType');
            const userId = sessionStorage.getItem('userId');

            console.log('userType:', userType);
            console.log('userId:', userId);
            if (userType == "administrador"){
              //alert('Bienvenido Admin');
             
            }else{
              alert('Será redireccionado, página autorizada sólo a Admin');
              window.location.href="/login.html";
            }
      

        });


        // Función para obtener la fecha actual en el formato YYYY-MM-DD
function obtenerFechaActual() {
            const fechaActual = new Date();
            const year = fechaActual.getFullYear();
            const month = (fechaActual.getMonth() + 1).toString().padStart(2, '0');
            const day = fechaActual.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }



    </script>
</body>
</html>
